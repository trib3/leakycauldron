<html>
<head>
    <title>GraphiQL</title>
    <link href="//unpkg.com/graphiql@1.4.6/graphiql.min.css" rel="stylesheet"/>
</head>
<body style="margin: 0;">
<div id="graphiql" style="height: 100vh;"></div>

<script crossorigin src="//unpkg.com/react@17.0.2/umd/react.production.min.js"></script>
<script crossorigin src="//unpkg.com/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
<script crossorigin src="//unpkg.com/graphiql@1.4.6/graphiql.min.js"></script>
<script crossorigin src="//unpkg.com/graphql-ws@5.5.5/umd/graphql-ws.min.js"></script>

<script>
    const fetcherFactory = function (subscriptionsClient, fallbackFetcher) {
      var cleanupCallback = null;
      var results = [];
      return function (graphQLParams, fetcherOpts) {
        if (subscriptionsClient && cleanupCallback !== null) {
          cleanupCallback();
          results = [];
        }
        var isSubscription = fetcherOpts.documentAST.definitions.some((definition) => definition.operation == 'subscription');
        if (subscriptionsClient && isSubscription) {
          return {
            subscribe: function (observer) {
              observer.next('Your subscription data will appear here after server publication!');
              cleanupCallback = subscriptionsClient.subscribe({
                query: graphQLParams.query,
                variables: graphQLParams.variables,
              }, {
                next: function (result) {
                  results.push({path: `${results.length}`, ...result});
                  if (results.length % 10 == 0) { // debounce
                    observer.next(results);
                  }
                }, error: function(error) {
                  observer.error(error);
                },
                complete: function() {
                  observer.next(results); // on completion show all results
                },
              });
            },
          };
        } else {
          return fallbackFetcher(graphQLParams);
        }
      };
    };

    const graphQLFetcher = graphQLParams =>
      fetch('/app/graphql', {
        method: 'post',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(graphQLParams),
      })
        .then(response => response.json())
        .catch(() => response.text());
    const wsproto = (window.location.protocol == 'https:') ? 'wss' : 'ws';
    fetch('/app/auth_cookie', {
      method: 'get'
    }).then(response => {
        const subscriptionsClient = graphqlWs.createClient({
            url: `${wsproto}://${window.location.host}/app/graphql`,
            lazyCloseTimeout: 60000
        });
        const subscriptionsFetcher = fetcherFactory(subscriptionsClient, graphQLFetcher);
        ReactDOM.render(
          React.createElement(GraphiQL, { fetcher: subscriptionsFetcher }),
          document.getElementById('graphiql'),
        );
    });

</script>
</body>
</html>
